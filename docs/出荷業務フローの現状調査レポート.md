# 出荷業務フローの現状調査レポート

## 調査概要
本レポートは、商品購入から出荷完了までの業務フロー、スタッフとセラーの役割、およびシステム活用の動線について現状を調査・整理したものです。

## 1. 全体フローの概要

### 1.1 基本フロー
```
購入通知 → ピッキング → 検査 → 梱包 → 伝票発行 → 出荷
```

### 1.2 システム上のステータス遷移
```
pending_inspection → inspected → packed → shipped → delivered
```

## 2. 購入通知から開始される処理

### 2.1 購入通知の仕組み
**トリガー**: eBay APIからの購入通知
**通知方法**: Server-Sent Events (SSE) による リアルタイム通知
**対象者**: スタッフのみ（セラーは出荷に関与しない）

### 2.2 通知の内容と種類
**実装場所**: `app/api/notifications/stream/route.ts`

#### スタッフ向け通知:
- **出荷期限通知**: 本日出荷予定の商品
- **新規タスク通知**: 検品・ピッキング待ちの商品
- **システムアラート**: 在庫位置不一致などの問題

#### セラー向け通知:
- **注文通知**: 新規注文の発生
- **在庫アラート**: 高額商品の在庫期間超過
- **価格変更推奨**: 市場価格変動に基づく推奨

## 3. スタッフとセラーの役割分担

### 3.1 スタッフの役割
**権限**: 出荷業務の全権限
**担当業務**:
1. ピッキング作業
2. 商品検査
3. 梱包作業
4. 配送伝票作成・貼付
5. 出荷処理

### 3.2 セラーの役割
**権限**: 出荷状況の確認のみ
**担当業務**:
1. 注文状況の確認
2. 配送計画の作成（参考情報として）
3. 返品処理の確認

**制限事項**:
- 実際の出荷作業には一切関与しない
- ピッキング・梱包作業へのアクセス権なし

## 4. ピッキング業務フロー

### 4.1 ピッキングタスクの生成
**実装場所**: `app/api/picking/route.ts`
**処理内容**:
- 購入通知を受けて自動的にピッキングタスクを生成
- 50件以上の大量タスクを同時処理可能
- 商品の倉庫内位置情報を含む

### 4.2 ピッキング作業の流れ
1. **タスク確認**: スタッフページ(`/staff/picking`)でタスク一覧表示
2. **タスク開始**: 「開始」ボタンでステータスを`pending` → `in_progress`に変更
3. **商品ピッキング**: 倉庫内位置を確認して商品を収集
4. **数量確認**: ピッキング済み数量の記録
5. **タスク完了**: 全アイテム完了で`completed`ステータスに更新

### 4.3 倉庫管理システム
**位置管理**:
- **STD-A-01～04**: カメラ本体エリア
- **HUM-01～06**: レンズエリア（湿度管理）
- **DRY-01～02**: アクセサリーエリア
- **TEMP-01～03**: 温度管理エリア

## 5. 検査・梱包業務フロー

### 5.1 検査プロセス
**実装場所**: `app/staff/shipping/page.tsx`
**処理内容**:
1. **検査前状態**: `pending_inspection`
2. **検査実行**: バーコードスキャンで商品確認
3. **検査完了**: `inspected`ステータスに更新
4. **検査ノート**: 動作確認・外観チェック結果を記録

### 5.2 梱包プロセス
**梱包指示システム**: `app/components/features/shipping/PackingInstructions.tsx`
1. **商品価値判定**: 50万円以上は保険付き配送を推奨
2. **梱包材選択**: 商品特性に応じた最適な梱包材を提案
3. **梱包完了**: `packed`ステータスに更新

### 5.3 高額商品の特別処理
- **保険付き配送**: 50万円以上の商品は自動で保険付きを提案
- **特別梱包**: 高額商品は専用の梱包材を使用
- **追跡強化**: 高額商品は配送状況の詳細追跡

## 6. 配送伝票発行・出荷処理

### 6.1 伝票発行システム
**実装場所**: `app/api/pdf/generate/route.ts`
**対応伝票**:
- **配送ラベル**: 配送業者用のラベル
- **ピッキングリスト**: 作業指示書
- **納品書**: 顧客向け書類

### 6.2 配送業者との連携
**対応業者**:
- ヤマト運輸
- 佐川急便
- 日本郵便
- FedEx
- DHL Express
- UPS

### 6.3 出荷処理の流れ
1. **伝票印刷**: PDFで配送ラベルを生成
2. **伝票貼付**: 印刷したラベルを商品に貼付
3. **出荷記録**: `shipped`ステータスに更新
4. **追跡番号登録**: 配送業者から取得した追跡番号を記録

## 7. システム操作の詳細動線

### 7.1 スタッフの操作動線

#### パターン1: ピッキングから開始
1. **ダッシュボード確認** → 緊急タスク通知を確認
2. **ピッキングページ** (`/staff/picking`) → タスク一覧表示
3. **タスク選択** → 「開始」ボタンクリック
4. **商品収集** → 倉庫内の指定位置から商品を収集
5. **数量確認** → 収集した数量を記録
6. **タスク完了** → 「完了」ボタンで次工程へ

#### パターン2: 出荷処理画面から
1. **出荷管理ページ** (`/staff/shipping`) → 出荷待ち商品一覧
2. **商品選択** → 詳細モーダル表示
3. **検査実行** → バーコードスキャンで商品確認
4. **梱包指示確認** → システムから梱包方法を確認
5. **伝票印刷** → PDFラベル生成・印刷
6. **出荷完了** → ステータス更新・追跡番号登録

### 7.2 セラーの操作動線

#### セラーの確認可能事項
1. **ダッシュボード** (`/dashboard`) → 注文・売上状況の確認
2. **売上管理** (`/sales`) → 注文詳細・配送状況の確認
3. **配送計画** (`/delivery`) → 配送予定の確認（参考情報）

#### セラーの制限事項
- 実際の出荷作業画面へのアクセス不可
- ピッキング・梱包作業の操作不可
- 配送業者への直接指示不可

## 8. システム連携とデータフロー

### 8.1 API連携
**注文管理API**: `/api/orders/route.ts`
- 注文作成・更新・ステータス管理
- 商品ステータスの自動更新（storage → ordered → shipping → sold）

**ピッキングAPI**: `/api/picking/route.ts`
- タスク生成・進捗管理・完了処理
- バッチピッキング機能

**出荷API**: `/api/shipping/route.ts`
- 出荷情報管理・追跡情報更新

### 8.2 リアルタイム更新
**通知システム**: SSE による即座の情報更新
**進捗管理**: 各工程の進捗をリアルタイム表示
**ステータス同期**: 複数画面間でのステータス自動同期

## 9. 品質管理とエラー対応

### 9.1 品質チェックポイント
1. **ピッキング精度**: 99.5%の精度を維持
2. **梱包品質**: 商品価値に応じた適切な梱包
3. **配送精度**: 追跡番号による配送状況管理

### 9.2 エラー対応
**在庫不一致**: システムアラートで即座に通知
**配送遅延**: 期限超過時の緊急対応フラグ
**返品処理**: 高額返品の優先処理

## まとめ

### 現状の特徴
1. **完全自動化**: 購入通知から出荷まで一貫したシステム処理
2. **役割の明確化**: スタッフが実作業、セラーは確認のみ
3. **品質重視**: 高額商品への特別な配慮と追跡
4. **効率性**: 大量注文の同時処理能力

### 業務フローの要点
- 購入通知 → 自動タスク生成 → スタッフ作業 → 出荷完了
- セラーは出荷プロセスに直接関与せず、状況確認のみ
- スタッフが全出荷責任を持つ品質重視の設計
- リアルタイム通知とステータス管理で効率的運用